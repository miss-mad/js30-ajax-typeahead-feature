<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link
      rel="icon"
      type="image/x-icon"
      href="./assets/images/typeahead_screenshot.png"
      alt="Typeahead icon"
    />
    <link rel="stylesheet" href="style.css" />
    <title>Typeahead Feature</title>
  </head>
  <body>
    <form class="search-form">
      <input type="text" class="search" placeholder="City or State" />
      <ul class="suggestions">
        <li>Filter for a city</li>
        <li>or a state</li>
      </ul>
    </form>
    <script>
      // cities.json file on github - a giant array of objects that contain all cities so we can filter them
      const endpoint =
        "https://gist.githubusercontent.com/Miserlou/c5cd8364bf9b2420bb29/raw/2bf258763cdddd704f8ffd3ea9a3e81d25e2c6f6/cities.json";

      // empty array to put the cities into
      const cities = [];

      // fetch the data with the browser-built-in fetch method
      // fetch returns a promise (something will eventually come back from this promise)
      // .then() returns a blob of data (called blob)
      // the data that is returned from our fetch (the blob) could be any data type - fetch doesn't know the type. even though we know it's JSON and we could do JSON.parse, the blob has to be converted from the raw data it's in into JSON
      fetch(endpoint)
        .then((blob) => blob.json())
        // use spread operator so that the array doesn't put each city as its own item in the array
        // spread into the push method to create the array of 1000 cities
        .then((data) => cities.push(...data));

      // function to find the matches in the giant cities array
      function findMatches(wordToMatch, cities) {
        return cities.filter((place) => {
          // here we need to figure out if the city/state matches what was searched - do this with regexes
          // g = global search; i = case-insensitive search
          const regex = new RegExp(wordToMatch, "gi");
          return place.city.match(regex) || place.state.match(regex);
        });
      }

      // function to put commas into the population number
      function numberWithCommas(x) {
        return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      }

      // function to display the matches found
      // called whenever someone changes the value
      function displayMatches() {
        const matchArray = findMatches(this.value, cities);
        // map() returns an array but we want a string; .join("") changes it from an array with multiple items into one big string
        const html = matchArray
          .map((place) => {
            const regex = new RegExp(this.value, "gi");
            const cityName = place.city.replace(
              regex,
              `<span class="hl">${this.value}</span>`
            );
            const stateName = place.state.replace(
              regex,
              `<span class="hl">${this.value}</span>`
            );
            return `<li><span class="name">${cityName}, ${stateName}</span><span class="population">${numberWithCommas(
              place.population
            )}</span></li>`;
          })
          .join("");
        suggestions.innerHTML = html;
      }

      const searchInput = document.querySelector(".search");
      const suggestions = document.querySelector(".suggestions");

      // change event only fires when you click outside of the input box; keyup watches for each key stroke
      searchInput.addEventListener("change", displayMatches);
      searchInput.addEventListener("keyup", displayMatches);
    </script>
  </body>
</html>
